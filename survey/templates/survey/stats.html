{% extends "survey/survey_menu.html" %}
{% load custom_template_tags %}

{% block content %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2/dist/chart.min.js"></script>

    <!-- Import D3 Scale Chromatic via CDN -->
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <h1>Statystyki ankiety</h1>
    <p class="lead"><b>Tytuł:</b> {{ survey_name }}</p>
    <div class="container" id="chart-container" style="max-width: 600px; max-height: 600px;">
    {% for title, labels, data in zipped_data %}
        {% if forloop.first %}
        <!-- Charts config -->
        <script type="text/javascript">
            const borderWidth = 1;
            const colorScale = d3.interpolateWarm;
            const colorRangeInfo = {
                colorStart: 0,
                colorEnd: 1,
                useEndAsStart: false,
            }; 

            var rgb_colors = interpolateColors({{ max_len }}, colorScale, colorRangeInfo);
            var rgba_colors = [];

            for (let color of rgb_colors) {
                new_color = color.replace(/rgb/i, "rgba");
                new_color = new_color.replace(/\)/i,',0.2)');

                rgba_colors.push(new_color);
            }
        </script>
        {% endif %}
    
    <canvas id="chart{{ forloop.counter }}-canvas"></canvas>
    <a download='chart' href="#" class="btn btn-dark btn-sm disabled" id="chart{{ forloop.counter }}-url">Pobierz wykres w PNG</a>
    
    <script type="text/javascript">
        $( document ).ready(function() {
            var ctx = $("#chart{{ forloop.counter }}-canvas").get(0).getContext("2d");
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: {{ labels|safe }},
                    datasets: [
                        {
                            data: {{ data|safe }},
                            borderColor: rgb_colors,
                            borderWidth: borderWidth,
                            backgroundColor: rgba_colors,
                        },
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '{{ title|safe }}'
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        },
                    },
                    animation: {
                        onComplete: function() {
                            var base64 = this.toBase64Image();
                            $("#chart{{ forloop.counter }}-url").attr("href", base64).removeClass("disabled");
                        }
                    },    
                },
            });
        });
                    
    </script>
    {% empty %}
    <div class="alert alert-dark" role="alert"><b>Brak danych do przedstawienia na wykresach.</b><br>Brak odpowiedzi na wybraną ankietę.</div>
    {% endfor %}
    </div>
{% endblock content %}
